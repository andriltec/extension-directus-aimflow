import{ref as e,watch as n,resolveComponent as t,openBlock as a,createElementBlock as o,createElementVNode as i,createVNode as r,toDisplayString as s,createTextVNode as l,createCommentVNode as d,Fragment as c,renderList as p,normalizeClass as u,withDirectives as h,withKeys as g,vModelText as m,onMounted as f,createBlock as v,withCtx as b}from"vue";function x(e){const n=e.instrucoes||"",t=Array.isArray(e.artigos)?e.artigos.map((e=>{const n=e.item||{};return`\n---\n${n.titulo?`Título: ${n.titulo}\n`:""}${n.conteudo||""}`})).join(""):"";return n+(t.trim()?`\n\nBase de conhecimento:\n${t}`:"")}var y=[],w=[];function _(e,n){if(e&&"undefined"!=typeof document){var t,a=!0===n.prepend?"prepend":"append",o=!0===n.singleTag,i="string"==typeof n.container?document.querySelector(n.container):document.getElementsByTagName("head")[0];if(o){var r=y.indexOf(i);-1===r&&(r=y.push(i)-1,w[r]={}),t=w[r]&&w[r][a]?w[r][a]:w[r][a]=s()}else t=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),t.styleSheet?t.styleSheet.cssText+=e:t.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),n.attributes)for(var t=Object.keys(n.attributes),o=0;o<t.length;o++)e.setAttribute(t[o],n.attributes[t[o]]);var r="prepend"===a?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}_("\n.chat-fullscreen[data-v-0232e851] {\n  position: absolute;\n  top: var(--content-top, 56px);\n  left: 0;\n  width: 100%;\n  height: calc(100vh - 56px);\n  background: var(--theme--background, #18181a);\n  display: flex;\n  flex-direction: column;\n  z-index: 2;\n}\n.chat-header[data-v-0232e851] {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 26px 28px 12px 28px;\n  border-bottom: 1px solid var(--theme--border-subdued,#22222a);\n  background: var(--theme--background, #18181a);\n}\n.header-left[data-v-0232e851] {\n  display: flex;\n  align-items: center;\n}\n.chat-title[data-v-0232e851] {\n  font-size: 1.18rem;\n  font-weight: 600;\n  color: var(--theme--primary-text, #fff);\n}\n.close-btn[data-v-0232e851] {\n  background: none;\n  border: none;\n  outline: none;\n  cursor: pointer;\n  color: var(--theme--primary-text,#fff);\n  padding: 4px 8px;\n  border-radius: 50%;\n  transition: background .2s;\n}\n.close-btn[data-v-0232e851]:hover {\n  background: rgba(120,120,120,0.12);\n}\n.chat-content[data-v-0232e851] {\n  flex: 1 1 auto;\n  padding: 32px 28px 24px 28px;\n  overflow-y: auto;\n  background: var(--theme--background, #18181a);\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n.empty-msg[data-v-0232e851] {\n  color: #aaa;\n  text-align: center;\n  font-size: 1.1rem;\n  margin-top: 36px;\n}\n.msg[data-v-0232e851] {\n  align-self: flex-start;\n  max-width: 80%;\n  margin: 2px 0;\n  padding: 10px 14px;\n  border-radius: 10px;\n  font-size: 1.02rem;\n  background: var(--theme--background-subdued,#23232a);\n  color: #eee;\n  line-height: 1.5;\n}\n.msg.user[data-v-0232e851] {\n  align-self: flex-end;\n  background: #4f46e5;\n  color: #fff;\n}\n.msg-user[data-v-0232e851] {\n  color: #b8b8ff;\n  font-weight: 500;\n  margin-right: 4px;\n}\n.msg-agent[data-v-0232e851] {\n  color: #a8a8a8;\n  font-weight: 500;\n  margin-right: 4px;\n}\n.chat-input-bar[data-v-0232e851] {\n  display: flex;\n  align-items: center;\n  padding: 22px 28px 28px 28px;\n  border-top: 1px solid var(--theme--border-subdued,#22222a);\n  background: var(--theme--background, #18181a);\n}\n.chat-input[data-v-0232e851] {\n  flex: 1 1 auto;\n  font-size: 1.12rem;\n  padding: 13px 16px;\n  border-radius: 7px;\n  border: none;\n  outline: none;\n  background: var(--theme--background-subdued,#23232a);\n  color: #fff;\n  margin-right: 10px;\n}\n.chat-input[data-v-0232e851]::placeholder {\n  color: #aaa;\n}\n.send-btn[data-v-0232e851] {\n  background: #4f46e5;\n  border: none;\n  border-radius: 50%;\n  width: 44px;\n  height: 44px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: #fff;\n  font-size: 1.2rem;\n  cursor: pointer;\n  transition: background .2s;\n}\n.send-btn[data-v-0232e851]:hover {\n  background: #3730a3;\n}\n",{});var k=(e,n)=>{const t=e.__vccOpts||e;for(const[e,a]of n)t[e]=a;return t};const z={key:0,class:"chat-fullscreen"},I={class:"chat-header"},A={class:"header-left"},S={class:"chat-title"},C={style:{display:"flex",gap:"10px","align-items":"center"}},j={class:"chat-content"},O={key:0,class:"empty-msg"},$={key:0,class:"msg-user"},T={key:1,class:"msg-agent"},B={class:"chat-input-bar"},q={__name:"ChatAgente",props:{agente:{type:Object,required:!0},show:{type:Boolean,required:!0},historicoId:{type:[String,null],default:null}},emits:["update:show","finalizar-chat"],setup(f,{emit:v}){const b=f,y=v,w=e(""),_=e([]),k=e(!1);async function q(){if(!b.agente)return;if(E._histId=null,b.historicoId){const e=await fetch(`/items/chat_historico/${b.historicoId}?fields=mensagens,finalizado`,{headers:{...localStorage.getItem("directus_token")?{Authorization:`Bearer ${localStorage.getItem("directus_token")}`}:{}}}),n=await e.json();return _.value=n.data?.mensagens?.mensagens||[],E._histId=n.data?.id,void(k.value=!!n.data?.finalizado)}const e=b.agente.id,n=await fetch(`/items/chat_historico?filter[agente][_eq]=${e}&filter[finalizado][_eq]=false&fields=mensagens`,{}),t=await n.json();t.data&&t.data.length?(_.value=t.data[0].mensagens?.mensagens||[],E._histId=t.data[0].id,k.value=!!t.data[0].finalizado):(_.value=[],k.value=!1)}async function E(e=!1){if(!b.agente)return;const n=b.agente.id,t={agente:n,mensagens:{mensagens:_.value},finalizado:e};if(!E._histId){const e=await fetch(`/items/chat_historico?filter[agente][_eq]=${n}&filter[finalizado][_eq]=false`,{headers:{...localStorage.getItem("directus_token")?{Authorization:`Bearer ${localStorage.getItem("directus_token")}`}:{}}}),t=await e.json();t.data&&t.data.length&&(E._histId=t.data[0].id)}if(E._histId)await fetch(`/items/chat_historico/${E._histId}`,{method:"PATCH",headers:{"Content-Type":"application/json",...localStorage.getItem("directus_token")?{Authorization:`Bearer ${localStorage.getItem("directus_token")}`}:{}},body:JSON.stringify(t)});else{const e=await fetch("/items/chat_historico",{method:"POST",headers:{"Content-Type":"application/json",...localStorage.getItem("directus_token")?{Authorization:`Bearer ${localStorage.getItem("directus_token")}`}:{}},body:JSON.stringify(t)}),n=await e.json();n.data&&n.data.id&&(E._histId=n.data.id)}}async function P(){if(k.value)return;if(!w.value.trim())return;const e={autor:"user",texto:w.value,timestamp:(new Date).toISOString()};_.value.push(e),E();const n=w.value;w.value="",_.value.push({autor:"agente",texto:"...",timestamp:(new Date).toISOString()});const t=[{role:"system",content:x(b.agente)},..._.value.filter((e=>"agente"!==e.autor||"..."!==e.texto)).map((e=>({role:"user"===e.autor?"user":"assistant",content:e.texto}))),{role:"user",content:n}];let a="[Sem resposta do agente]";try{const e=b.agente?.chave_openai?.chave_api;if(!e)throw new Error("Chave OpenAI não encontrada para este agente");const n=function(e){const n=[];return Array.isArray(e.webhook)&&e.webhook.length>0&&e.webhook.forEach((e=>{const t=e.item||{};n.push({name:(t.nome||"").replace(/\s/g,"_").toLowerCase(),description:t.contexto||`Executa o webhook ${t.nome}`,parameters:{type:"object",properties:{},required:[],additionalProperties:!1}})})),Array.isArray(e.endpoints)&&e.endpoints.length>0&&e.endpoints.forEach((e=>{const t=e.item||{},a=t.plataforma||{},o=(a.nome||"endpoint").replace(/\s/g,"_").toLowerCase(),i=`Chama o endpoint da plataforma ${a.nome||""} (${t.url||""})`;n.push({name:o,description:i,parameters:{type:"object",properties:{chave_api:{type:"string",description:"Chave de API para autenticação"},url:{type:"string",description:"URL do endpoint"}},required:["chave_api","url"],additionalProperties:!1}})})),n}(b.agente).map((e=>({type:"function",function:e})));let o={model:"gpt-4o-mini",messages:t,temperature:.7,max_tokens:1e3,functions:n.length?n:void 0};Object.keys(o).forEach((e=>void 0===o[e]&&delete o[e])),console.log("Payload enviado ao OpenAI:",o);let i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)}),r=await i.json();console.log("Resposta OpenAI:",r);const s=r.choices?.[0];if(s&&"function_call"===s.finish_reason&&s.message?.function_call){const{name:n,arguments:l}=s.message.function_call;let d=`[Função '${n}' chamada com argumentos: ${l}]`;const c=[...t,{role:"assistant",content:null,function_call:{name:n,arguments:l}},{role:"function",name:n,content:d}];o={model:"gpt-4o-mini",messages:c,temperature:.7,max_tokens:1e3},i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)}),r=await i.json(),a=r.choices?.[0]?.message?.content||"[Sem resposta do agente após function_call]"}else a=s?.message?.content||"[Sem resposta do agente]"}catch(e){console.error("Erro ao chamar OpenAI:",e),a="[Erro ao obter resposta do agente]"}const o=_.value.findIndex((e=>"agente"===e.autor&&"..."===e.texto));-1!==o?_.value[o]={autor:"agente",texto:a,timestamp:(new Date).toISOString()}:_.value.push({autor:"agente",texto:a,timestamp:(new Date).toISOString()}),E()}return n((()=>b.show),(e=>{e?q():(_.value=[],k.value=!1)})),n((()=>b.historicoId),(e=>{b.show&&e&&q()})),n(_,E,{deep:!0}),(e,n)=>{const v=t("VIcon");return f.show?(a(),o("div",z,[i("div",I,[i("div",A,[r(v,{name:"account_circle",size:"32",color:"var(--theme--primary)",style:{"margin-right":"10px"}}),i("span",S,s(f.agente.nome),1)]),i("div",C,[E._histId&&!k.value?(a(),o("button",{key:0,class:"finalizar-btn",onClick:n[0]||(n[0]=e=>y("finalizar-chat",E._histId))},[r(v,{name:"check",size:"20"}),n[3]||(n[3]=l(" Finalizar "))])):d("v-if",!0),i("button",{class:"close-btn",onClick:n[1]||(n[1]=e=>y("update:show",!1))},[r(v,{name:"close",size:"24"})])])]),i("div",j,[_.value.length?d("v-if",!0):(a(),o("div",O,"Como posso ajudar?")),(a(!0),o(c,null,p(_.value,((e,n)=>(a(),o("div",{key:n,class:u(["msg",e.autor])},["user"===e.autor?(a(),o("span",$,"Você:")):(a(),o("span",T,s(f.agente.nome)+":",1)),i("span",null,s(e.texto),1)],2)))),128))]),i("div",B,[h(i("input",{"onUpdate:modelValue":n[2]||(n[2]=e=>w.value=e),class:"chat-input",type:"text",placeholder:"Pergunte alguma coisa",onKeyup:g(P,["enter"])},null,544),[[m,w.value]]),i("button",{class:"send-btn",onClick:P},[r(v,{name:"send",size:"22"})])])])):d("v-if",!0)}}};var E=k(q,[["__scopeId","data-v-0232e851"],["__file","ChatAgente.vue"]]);_("\n.content[data-v-8b043226] {\n  flex: 1 1 0;\n  padding: 32px 24px;\n  min-width: 0;\n  overflow-x: auto;\n  margin-top: 0;\n}\n\n/* Ajuste para o chat respeitar o header/navigation */\n[data-v-8b043226] .chat-agente-container,[data-v-8b043226] .chat-agente-main,[data-v-8b043226] .chat-agente-wrapper {\n  max-height: calc(100vh - 110px); /* Ajuste conforme altura do header/nav */\n  overflow-y: auto;\n  margin-top: 0;\n}\n.subtitle[data-v-8b043226] {\n  color: var(--theme--primary-text, #3a3a4a);\n  font-size: 1.1rem;\n  font-weight: 500;\n  margin-bottom: 20px;\n  letter-spacing: 0.02em;\n}\n.card-list[data-v-8b043226] {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 24px;\n  justify-content: flex-start;\n}\n.agent-card[data-v-8b043226] {\n  min-width: 240px;\n  max-width: 300px;\n  flex: 1 1 240px;\n  margin-bottom: 24px;\n  background: var(--theme--background-subdued, #fff);\n}\n.empty-msg[data-v-8b043226] {\n  text-align: center;\n  color: #888;\n  margin-top: 32px;\n  font-size: 1.1rem;\n}\n.nav-block[data-v-8b043226] {\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  background: var(--theme--background-subdued, #23232a);\n  padding: 8px 16px 10px 16px;\n  border-radius: 8px;\n  margin-bottom: 8px;\n  width: auto;\n  max-width: 100vw;\n  min-width: 0;\n  box-sizing: border-box;\n}\n.nav-title[data-v-8b043226] {\n  color: #fff;\n  font-size: 1.0rem;\n  font-weight: 600;\n  margin: 7px;\n  letter-spacing: 0.01em;\n}\n.nav-historico-list[data-v-8b043226] {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 10px;\n  list-style: none;\n  margin: 0 5px;\n  padding: 0;\n  width: calc(100% - 10px);\n  max-width: 100%;\n  overflow-x: auto;\n}\n.nav-historico-list li[data-v-8b043226] {\n  background: #23232a;\n  border: 1px solid #3730a3;\n  border-radius: 6px;\n  padding: 5px 10px;\n  color: #fff;\n  cursor: pointer;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  min-width: 90px;\n  max-width: 170px;\n  transition: background .2s, border .2s;\n  font-size: 0.97em;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n.nav-historico-list li[data-v-8b043226]:hover {\n  background: #3730a3;\n  border: 1px solid #4f46e5;\n}\n.nav-historico-list li.finalizado[data-v-8b043226] {\n  opacity: 0.6;\n}\n.nav-hist-title[data-v-8b043226] {\n  display: flex;\n  align-items: center;\n  gap: 5px;\n}\n.nav-finalizado-label[data-v-8b043226] {\n  background: #aaa;\n  color: #23232a;\n  font-size: 0.85em;\n  border-radius: 5px;\n  padding: 1px 5px;\n  margin-left: 5px;\n}\n.nav-hist-date[data-v-8b043226] {\n  color: #bbb;\n  font-size: 0.91em;\n  margin-top: 1px;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n\n/* Remover sidebar antigo */\n.sidebar-historico[data-v-8b043226], .historico-navigation[data-v-8b043226], .historico-label[data-v-8b043226], .historico-list-nav[data-v-8b043226], .historico-list-nav li[data-v-8b043226], .historico-list-nav li.finalizado[data-v-8b043226], .hist-title-nav[data-v-8b043226], .finalizado-label-nav[data-v-8b043226], .hist-date-nav[data-v-8b043226] {\n  display: none !important;\n}\n.sidebar-historico h3[data-v-8b043226] {\n  margin: 0 0 16px 0;\n  color: #fff;\n  font-size: 1.08rem;\n}\n.historico-list[data-v-8b043226] {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n}\n.historico-list li[data-v-8b043226] {\n  padding: 12px 10px;\n  border-radius: 6px;\n  margin-bottom: 8px;\n  background: #23232a;\n  cursor: pointer;\n  transition: background .2s;\n  border: 1px solid transparent;\n}\n.historico-list li[data-v-8b043226]:hover {\n  background: #3730a3;\n  border: 1px solid #4f46e5;\n}\n.historico-list li.finalizado[data-v-8b043226] {\n  opacity: 0.6;\n}\n.hist-title[data-v-8b043226] {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  color: #fff;\n}\n.finalizado-label[data-v-8b043226] {\n  background: #aaa;\n  color: #23232a;\n  font-size: 0.88em;\n  border-radius: 5px;\n  padding: 2px 8px;\n  margin-left: 8px;\n}\n.hist-date[data-v-8b043226] {\n  color: #bbb;\n  font-size: 0.95em;\n  margin-top: 3px;\n}\n\n",{});const P={class:"nav-block"},V={key:0,class:"nav-historico-list"},N=["onClick"],D={class:"nav-hist-title"},J={key:0,class:"nav-finalizado-label"},F={class:"nav-hist-date"},L={class:"content"},R={class:"card-list"},U={key:0},H={key:1,style:{color:"#aaa"}},K={key:0,class:"empty-msg"};const G=[],M=[],Q=[],W=[{id:"agentes-ia",name:"Agentes de IA",icon:"box",routes:[{path:"",component:k({__name:"module",setup(n){const h=e([]),g=e(!1),m=e(null),x=e([]),y=e(null);function w(e){const n=h.value.find((n=>n.id===e));return n?n.nome:"Agente"}function _(e){if(!e)return"";return new Date(e).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"})}function k(e){const n=m.value?.chave_openai?.chave_api;fetch(`/items/chat_historico/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:n?`Bearer ${n}`:void 0},body:JSON.stringify({finalizado:!0})}).then((()=>z()))}async function z(){const e=await fetch("/items/chat_historico?fields=id,agente,finalizado,date_created&sort[]=-date_created",{}),n=await e.json();x.value=n.data||[]}return f((async()=>{const e=await fetch("/items/agente?fields[]=id,nome,descricao,status,chave_openai.chave_api&filter[status][_eq]=true"),n=await e.json();h.value=n.data||[],await z()})),(e,n)=>{const f=t("VIcon"),z=t("VCardTitle"),I=t("VCardText"),A=t("VButton"),S=t("VCardActions"),C=t("VCard"),j=t("private-view");return a(),v(j,{title:"Agentes de IA"},{navigation:b((()=>[i("div",P,[n[1]||(n[1]=i("div",{class:"nav-title"},"Conversas",-1)),x.value.length?(a(),o("ul",V,[(a(!0),o(c,null,p(x.value,(e=>(a(),o("li",{key:e.id,onClick:n=>function(e){const n=h.value.find((n=>n.id===e.agente));n&&(m.value=n,g.value=!0,y.value=e.id)}(e),class:u({finalizado:e.finalizado})},[i("span",D,[i("b",null,s(w(e.agente).length>100?w(e.agente).slice(0,100)+"...":w(e.agente)),1),e.finalizado?(a(),o("span",J,"Finalizado")):d("v-if",!0)]),i("span",F,s(_(e.date_created)),1)],10,N)))),128))])):d("v-if",!0)])])),default:b((()=>[i("div",L,[n[3]||(n[3]=i("h2",{class:"subtitle"},"Agentes Ativos",-1)),i("div",R,[(a(!0),o(c,null,p(h.value,(e=>(a(),v(C,{key:e.id,class:"agent-card"},{prepend:b((()=>[r(f,{name:"account_circle",size:"32",color:"var(--theme--primary)"})])),default:b((()=>[r(z,null,{default:b((()=>[l(s(e.nome),1)])),_:2},1024),r(I,null,{default:b((()=>[e.descricao?(a(),o("span",U,s(e.descricao),1)):(a(),o("span",H,"Sem descrição"))])),_:2},1024),r(S,null,{default:b((()=>[r(A,{color:"primary",onClick:n=>function(e){m.value=e,g.value=!0,y.value=null}(e)},{default:b((()=>n[2]||(n[2]=[l(" Acessar Chat ")]))),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))]),h.value.length?d("v-if",!0):(a(),o("div",K,"Nenhum agente ativo encontrado."))]),g.value&&m.value?(a(),v(E,{key:0,agente:m.value,show:g.value,"onUpdate:show":n[0]||(n[0]=e=>{g.value=e,e||(m.value=null)}),onFinalizarChat:k,"historico-id":y.value},null,8,["agente","show","historico-id"])):d("v-if",!0)])),_:1})}}},[["__scopeId","data-v-8b043226"],["__file","module.vue"]])}]}],X=[],Y=[],Z=[];export{M as displays,G as interfaces,Q as layouts,W as modules,Z as operations,X as panels,Y as themes};
